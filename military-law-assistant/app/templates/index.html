<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="South African Law Assistant for legal reference">
    <title>South African Law Assistant</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" as="style">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" 
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Favicon and PWA -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    
    <!-- Inline critical CSS -->
    <style>
        :root {
            --primary: #1976d2;
            --danger: #dc3545;
            --success: #198754;
            --dark: #212529;
        }
        body { 
            background: #f5f5f5; 
            padding-top: 20px;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        .card { 
            max-width: 650px; 
            margin: 0 auto; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        .answer-box { 
            background: #e8f4fc; 
            min-height: 150px; 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        #recordBtn.recording { 
            background-color: var(--danger) !important; 
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .status-message { 
            font-size: 0.9rem; 
            margin-top: 5px; 
            min-height: 20px;
        }
        .answer-content { 
            white-space: pre-wrap; 
            line-height: 1.6;
        }
        .document-reference {
            font-size: 0.8rem;
            color: var(--dark);
            margin-top: 10px;
            border-left: 3px solid var(--primary);
            padding-left: 10px;
        }
        .badge-ref {
            background-color: var(--primary);
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .spinner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        #uploadBtn {
            position: relative;
            overflow: hidden;
        }
        .legal-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .category-badge {
            cursor: pointer;
            transition: all 0.2s;
        }
        .category-badge.active {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px var(--primary);
        }
        @media (max-width: 576px) {
            .card {
                margin: 0 10px;
                padding: 15px !important;
            }
            .input-group {
                flex-direction: column;
            }
            #askBtn {
                margin-top: 10px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card p-4">
            <h1 class="text-center mb-4 text-primary">
                <i class="bi bi-balance" aria-hidden="true"></i> South African Law Assistant
            </h1>
            
            <div class="legal-categories">
                <span class="badge bg-primary category-badge active" data-category="all">All Law</span>
                <span class="badge bg-danger category-badge" data-category="military">Military</span>
                <span class="badge bg-warning text-dark category-badge" data-category="police">Police</span>
                <span class="badge bg-success category-badge" data-category="criminal">Criminal</span>
                <span class="badge bg-info text-dark category-badge" data-category="constitutional">Constitution</span>
                <span class="badge bg-secondary category-badge" data-category="correctional">Correctional</span>
            </div>
            
            <div class="mb-3">
                <label for="question" class="form-label fw-bold">Ask your question:</label>
                <div class="input-group">
                    <input type="text" id="question" class="form-control" 
                           placeholder="Type or record your question..." aria-label="Question input"
                           aria-describedby="askBtn">
                    <button id="askBtn" class="btn btn-primary" aria-label="Submit question">
                        <i class="bi bi-send" aria-hidden="true"></i> Ask
                    </button>
                </div>
                <div id="questionHelp" class="form-text">Ask about South African law</div>
            </div>
            
            <div class="d-flex gap-2 mb-4">
                <button id="recordBtn" class="btn btn-danger flex-grow-1" aria-label="Record voice question">
                    <i class="bi bi-mic" aria-hidden="true"></i> Record Voice
                </button>
                <button id="uploadBtn" class="btn btn-secondary" aria-label="Upload audio file">
                    <i class="bi bi-upload" aria-hidden="true"></i> Upload
                    <input type="file" id="voiceUpload" accept="audio/*" style="display:none;" aria-hidden="true">
                </button>
            </div>
            
            <div id="statusMessage" class="status-message text-muted" aria-live="polite"></div>
            
            <div id="questionDisplay" class="alert alert-info mb-3" style="display:none;" aria-live="polite">
                <strong>You asked:</strong> <span id="transcribedQuestion"></span>
            </div>
            
            <div class="answer-box" id="answer" aria-live="polite">
                <p class="text-muted">Your answer will appear here...</p>
            </div>
            
            <div class="document-reference mt-2" id="documentReferences" style="display:none;">
                <strong>References:</strong> <span id="referencesText"></span>
            </div>
        </div>
    </div>

    <!-- Deferred JS loading -->
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" 
            crossorigin="anonymous"></script>
    
    <script>
        // Immediately Invoked Function Expression (IIFE) for scoping
        (function() {
            'use strict';
            
            // DOM Elements
            const elements = {
                recordBtn: document.getElementById('recordBtn'),
                uploadBtn: document.getElementById('uploadBtn'),
                voiceUpload: document.getElementById('voiceUpload'),
                questionInput: document.getElementById('question'),
                askBtn: document.getElementById('askBtn'),
                answerBox: document.getElementById('answer'),
                questionDisplay: document.getElementById('questionDisplay'),
                transcribedQuestion: document.getElementById('transcribedQuestion'),
                statusMessage: document.getElementById('statusMessage'),
                documentReferences: document.getElementById('documentReferences'),
                referencesText: document.getElementById('referencesText')
            };
            
            // State management
            const state = {
                mediaRecorder: null,
                audioChunks: [],
                isProcessing: false,
                audioContext: null,
                selectedCategory: 'all'
            };
            
            // Initialize the app
            function init() {
                setupEventListeners();
                checkBrowserSupport();
                loadPreviousQuestion();
                registerServiceWorker();
            }
            
            // Set up all event listeners
            function setupEventListeners() {
                elements.recordBtn.addEventListener('click', toggleRecording);
                elements.uploadBtn.addEventListener('click', () => elements.voiceUpload.click());
                elements.voiceUpload.addEventListener('change', handleFileUpload);
                elements.askBtn.addEventListener('click', askQuestion);
                elements.questionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') askQuestion();
                });
                
                // Category selection
                document.querySelectorAll('.category-badge').forEach(badge => {
                    badge.addEventListener('click', function() {
                        document.querySelectorAll('.category-badge').forEach(b => 
                            b.classList.remove('active'));
                        this.classList.add('active');
                        state.selectedCategory = this.dataset.category;
                    });
                });
            }
            
            // Check for browser features
            function checkBrowserSupport() {
                if (!navigator.mediaDevices || !window.MediaRecorder) {
                    disableRecording();
                    showStatus("Voice recording not supported in your browser", "danger");
                    return false;
                }
                return true;
            }
            
            // Load previous question from session storage
            function loadPreviousQuestion() {
                const lastQuestion = sessionStorage.getItem('lastQuestion');
                if (lastQuestion) {
                    elements.questionInput.value = lastQuestion;
                }
            }
            
            // Register service worker for PWA
            function registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/sw.js')
                            .then(reg => console.log('Service Worker registered'))
                            .catch(err => console.error('Service Worker registration failed:', err));
                    });
                }
            }
            
            // Recording functions
            async function toggleRecording() {
                if (state.isProcessing) return;
                
                if (elements.recordBtn.classList.contains('recording')) {
                    await stopRecording();
                } else {
                    await startRecording();
                }
            }
            
            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    state.mediaRecorder = new MediaRecorder(stream);
                    state.audioChunks = [];
                    
                    state.mediaRecorder.ondataavailable = e => {
                        if (e.data.size > 0) state.audioChunks.push(e.data);
                    };
                    
                    state.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                        await processAudio(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    state.mediaRecorder.start(100);
                    elements.recordBtn.classList.add('recording');
                    elements.recordBtn.innerHTML = '<i class="bi bi-stop-fill" aria-hidden="true"></i> Stop Recording';
                    showStatus("Recording... Click to stop", "danger");
                } catch (err) {
                    console.error("Recording error:", err);
                    showStatus("Microphone access denied or error occurred", "danger");
                }
            }
            
            async function stopRecording() {
                if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
                    state.mediaRecorder.stop();
                    elements.recordBtn.classList.remove('recording');
                    elements.recordBtn.innerHTML = '<i class="bi bi-mic" aria-hidden="true"></i> Record Voice';
                    showStatus("Processing your recording...", "primary");
                }
            }
            
            // File upload handling
            async function handleFileUpload(e) {
                if (e.target.files.length === 0 || state.isProcessing) return;
                
                const file = e.target.files[0];
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showStatus("File too large (max 5MB)", "danger");
                    return;
                }
                
                showStatus(`Processing ${file.name}...`, "primary");
                await processAudio(file);
            }
            
            // Process audio and get answer
            async function processAudio(audioBlob) {
                if (state.isProcessing) return;
                state.isProcessing = true;
                
                try {
                    showLoading("Processing your voice note...");
                    
                    const formData = new FormData();
                    const audioFile = new File([audioBlob], 'voice_note.webm', { type: 'audio/webm' });
                    formData.append('audio', audioFile);
                    
                    const response = await fetchWithTimeout('/ask', {
                        method: 'POST',
                        body: formData,
                        timeout: 30000 // 30 seconds
                    });
                    
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: response.statusText }));
                        throw new Error(error.error || `Server error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    handleResponse(data);
                    
                } catch (err) {
                    console.error("Audio processing error:", err);
                    showError(err.message || "Failed to process audio");
                    showStatus("Error processing audio", "danger");
                } finally {
                    state.isProcessing = false;
                    elements.voiceUpload.value = ''; // Reset file input
                }
            }
            
            // Ask question via text
            async function askQuestion() {
                const question = elements.questionInput.value.trim();
                if (!question || state.isProcessing) return;
                state.isProcessing = true;
                
                try {
                    showLoading("Processing your question...");
                    elements.questionDisplay.style.display = 'none';
                    elements.documentReferences.style.display = 'none';
                    
                    const response = await fetchWithTimeout('/ask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `question=${encodeURIComponent(question)}`,
                        timeout: 30000 // 30 seconds
                    });
                    
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: response.statusText }));
                        throw new Error(error.error || `Server error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    handleResponse(data, question);
                    
                } catch (err) {
                    console.error("Error:", err);
                    showError(err.message || "Failed to get answer");
                    showStatus("Error getting answer", "danger");
                } finally {
                    state.isProcessing = false;
                }
            }
            
            // Handle API response
            function handleResponse(data, question = null) {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (question) {
                    elements.transcribedQuestion.textContent = question;
                    sessionStorage.setItem('lastQuestion', question);
                } else if (data.question) {
                    elements.questionInput.value = data.question;
                    elements.transcribedQuestion.textContent = data.question;
                    sessionStorage.setItem('lastQuestion', data.question);
                }
                
                elements.questionDisplay.style.display = 'block';
                elements.answerBox.innerHTML = `<div class="answer-content">${escapeHtml(data.answer).replace(/\n/g, '<br>')}</div>`;
                updateReferences(data.references || []);
                showStatus("Answer generated successfully", "success");
            }
            
            // Update document references
            function updateReferences(references) {
                if (references && references.length > 0) {
                    elements.referencesText.innerHTML = references.map(ref => 
                        `<span class="badge bg-primary badge-ref">${escapeHtml(ref)}</span>`
                    ).join(' ');
                    elements.documentReferences.style.display = 'block';
                } else {
                    elements.documentReferences.style.display = 'none';
                }
            }
            
            // Helper functions
            function disableRecording() {
                elements.recordBtn.disabled = true;
                elements.uploadBtn.disabled = true;
            }
            
            function showLoading(message) {
                elements.answerBox.innerHTML = `
                    <div class="spinner-container">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>${escapeHtml(message)}</p>
                    </div>`;
            }
            
            function showError(message) {
                elements.answerBox.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <strong>Error:</strong> ${escapeHtml(message)}
                    </div>`;
                elements.documentReferences.style.display = 'none';
            }
            
            function showStatus(message, type = "muted") {
                elements.statusMessage.textContent = message;
                elements.statusMessage.style.color = 
                    type === "danger" ? "var(--danger)" : 
                    type === "success" ? "var(--success)" : 
                    type === "primary" ? "var(--primary)" : "#6c757d";
            }
            
            function escapeHtml(unsafe) {
                return unsafe?.toString()
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;") || '';
            }
            
            async function fetchWithTimeout(resource, options = {}) {
                const { timeout = 8000 } = options;
                
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                
                const response = await fetch(resource, {
                    ...options,
                    signal: controller.signal  
                });
                
                clearTimeout(id);
                return response;
            }
            
            // Initialize the application
            document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>